#!/usr/bin/env node

/**
 * åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
 */

const Redis = require('ioredis')
const fs = require('fs')
const path = require('path')

// åŠ è½½ç¯å¢ƒå˜é‡
const envPath = path.join(__dirname, '..', '.env.local')
if (fs.existsSync(envPath)) {
  const envContent = fs.readFileSync(envPath, 'utf8')
  envContent.split('\n').forEach(line => {
    const match = line.match(/^([^=]+)=(.*)$/)
    if (match) {
      process.env[match[1].trim()] = match[2].trim().replace(/^["']|["']$/g, '')
    }
  })
}

async function listAllUsers() {
  const users = []
  const stats = {
    total: 0,
    byPlan: {
      free: 0,
      weekly: 0,
      monthly: 0,
      yearly: 0
    },
    verified: 0,
    unverified: 0,
    withSubscription: 0,
    expired: 0
  }

  // æ£€æŸ¥å­˜å‚¨ç±»å‹
  if (process.env.REDIS_URL && (process.env.REDIS_URL.startsWith('redis://') || process.env.REDIS_URL.startsWith('rediss://'))) {
    console.log('ğŸ“¦ ä½¿ç”¨ Redis å­˜å‚¨\n')
    
    const redis = new Redis(process.env.REDIS_URL, {
      maxRetriesPerRequest: 3,
      retryStrategy: (times) => {
        if (times > 3) return null
        return Math.min(times * 50, 2000)
      }
    })
    
    try {
      await redis.ping()
      console.log('âœ… Redis è¿æ¥æˆåŠŸ\n')
      
      const keys = await redis.keys('user:*')
      console.log(`ğŸ” æ‰¾åˆ° ${keys.length} ä¸ªç”¨æˆ·é”®\n`)
      
      for (const key of keys) {
        const email = key.replace('user:', '')
        const user = await redis.hgetall(key)
        
        if (user && user.id) {
          users.push({
            email: user.email,
            name: user.name,
            plan: user.plan || 'free',
            emailVerified: user.emailVerified === 'true',
            createdAt: user.createdAt,
            lastLoginAt: user.lastLoginAt,
            credits: user.credits || 0,
            subscriptionExpiresAt: user.subscriptionExpiresAt
          })
          
          // ç»Ÿè®¡
          stats.total++
          const plan = user.plan || 'free'
          if (plan === 'free' || plan === 'weekly' || plan === 'monthly' || plan === 'yearly') {
            stats.byPlan[plan] = (stats.byPlan[plan] || 0) + 1
          }
          if (user.emailVerified === 'true') stats.verified++
          else stats.unverified++
          if (user.subscriptionExpiresAt) {
            if (new Date(user.subscriptionExpiresAt) > new Date()) {
              stats.withSubscription++
            } else {
              stats.expired++
            }
          }
        }
      }
      
      await redis.quit()
    } catch (error) {
      console.error('âŒ Redis é”™è¯¯:', error.message)
      process.exit(1)
    }
  } else if (process.env.KV_REST_API_URL) {
    console.log('ğŸ“¦ ä½¿ç”¨ Vercel KV å­˜å‚¨\n')
    console.log('âš ï¸  KV å­˜å‚¨ä¸æ”¯æŒç›´æ¥åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·')
    console.log('   éœ€è¦ä½¿ç”¨å…¶ä»–æ–¹å¼è·å–ç”¨æˆ·åˆ—è¡¨\n')
    return
  } else {
    console.log('ğŸ“¦ ä½¿ç”¨æ–‡ä»¶å­˜å‚¨\n')
    
    try {
      const DATA_DIR = path.join(process.cwd(), 'data')
      const USERS_FILE = path.join(DATA_DIR, 'users.json')
      
      if (!fs.existsSync(USERS_FILE)) {
        console.log('âŒ ç”¨æˆ·æ–‡ä»¶ä¸å­˜åœ¨')
        return
      }
      
      const raw = fs.readFileSync(USERS_FILE, 'utf8')
      const json = JSON.parse(raw || '{"users":[]}')
      
      for (const user of json.users || []) {
        users.push({
          email: user.email,
          name: user.name,
          plan: user.plan || 'free',
          emailVerified: user.emailVerified,
          createdAt: user.createdAt,
          lastLoginAt: user.lastLoginAt,
          credits: user.credits || 0,
          subscriptionExpiresAt: user.subscriptionExpiresAt
        })
        
        // ç»Ÿè®¡
        stats.total++
        const plan = user.plan || 'free'
        if (plan === 'free' || plan === 'weekly' || plan === 'monthly' || plan === 'yearly') {
          stats.byPlan[plan] = (stats.byPlan[plan] || 0) + 1
        }
        if (user.emailVerified) stats.verified++
        else stats.unverified++
        if (user.subscriptionExpiresAt) {
          if (new Date(user.subscriptionExpiresAt) > new Date()) {
            stats.withSubscription++
          } else {
            stats.expired++
          }
        }
      }
    } catch (error) {
      console.error('âŒ æ–‡ä»¶è¯»å–é”™è¯¯:', error.message)
      process.exit(1)
    }
  }

  // æŒ‰æ³¨å†Œæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
  users.sort((a, b) => {
    const dateA = new Date(a.createdAt || 0).getTime()
    const dateB = new Date(b.createdAt || 0).getTime()
    return dateB - dateA
  })

  // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
  console.log('='.repeat(60))
  console.log('ğŸ“Š ç”¨æˆ·ç»Ÿè®¡')
  console.log('='.repeat(60))
  console.log(`æ€»ç”¨æˆ·æ•°: ${stats.total}`)
  console.log(`å·²éªŒè¯: ${stats.verified}`)
  console.log(`æœªéªŒè¯: ${stats.unverified}`)
  console.log(`æ´»è·ƒè®¢é˜…: ${stats.withSubscription}`)
  console.log(`è¿‡æœŸè®¢é˜…: ${stats.expired}`)
  console.log()
  console.log('æŒ‰è®¡åˆ’ç»Ÿè®¡:')
  console.log(`  å…è´¹ç”¨æˆ·: ${stats.byPlan.free}`)
  console.log(`  å‘¨ä»˜ç”¨æˆ·: ${stats.byPlan.weekly}`)
  console.log(`  æœˆä»˜ç”¨æˆ·: ${stats.byPlan.monthly}`)
  console.log(`  å¹´ä»˜ç”¨æˆ·: ${stats.byPlan.yearly}`)
  console.log('='.repeat(60))
  console.log()

  // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
  if (users.length === 0) {
    console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·')
    return
  }

  console.log('ğŸ“‹ ç”¨æˆ·åˆ—è¡¨:')
  console.log('='.repeat(60))
  users.forEach((user, index) => {
    console.log(`\n${index + 1}. ${user.name || 'æœªè®¾ç½®'} (${user.email})`)
    console.log(`   è®¡åˆ’: ${user.plan}`)
    console.log(`   å·²éªŒè¯: ${user.emailVerified ? 'âœ…' : 'âŒ'}`)
    console.log(`   ç§¯åˆ†: ${user.credits}`)
    if (user.subscriptionExpiresAt) {
      const expiresAt = new Date(user.subscriptionExpiresAt)
      const isActive = expiresAt > new Date()
      console.log(`   è®¢é˜…: ${isActive ? 'âœ… æ´»è·ƒ' : 'âŒ å·²è¿‡æœŸ'} (${expiresAt.toLocaleDateString('zh-CN')})`)
    }
    console.log(`   æ³¨å†Œæ—¶é—´: ${user.createdAt ? new Date(user.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}`)
    if (user.lastLoginAt) {
      console.log(`   æœ€åç™»å½•: ${new Date(user.lastLoginAt).toLocaleString('zh-CN')}`)
    }
  })
  console.log('\n' + '='.repeat(60))
  console.log(`\nâœ… å…±æ‰¾åˆ° ${users.length} ä¸ªç”¨æˆ·`)
}

listAllUsers().catch(error => {
  console.error('âŒ åˆ—å‡ºç”¨æˆ·å¤±è´¥:', error.message)
  process.exit(1)
})

