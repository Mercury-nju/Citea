# 📧 测试邮件发送功能

## ✅ 已完成配置

1. ✅ Redis 数据库已配置（Upstash）
2. ✅ Brevo API Key 已在 Vercel 重新配置
3. ✅ 邮件发送代码已优化（详细错误日志）
4. ✅ 注册流程已优化（无重复提示）

---

## 🧪 测试步骤

### 方法 1: 直接在网站注册（推荐）

1. **访问注册页面**
   - 生产地址：`https://your-production-domain.com/auth/signup`
   - 或 Vercel 预览地址（如果没有密码保护）

2. **使用测试邮箱注册**
   ```
   邮箱: lihongyangnju@gmail.com
   姓名: Test User
   密码: TestPassword123!
   ```

3. **注册后会自动跳转到验证页面**
   - 不会有重复的 alert 提示
   - 验证页面会显示："✅ 注册成功！验证码已发送到您的邮箱，请查收。"

4. **检查邮箱**
   - ✅ Gmail 收件箱
   - ✅ **垃圾邮件文件夹** ⭐ (最重要！)
   - ✅ **促销内容标签**
   - ✅ 搜索关键词：`Citea` 或 `noreply@brevo.com`

5. **邮件主题**
   ```
   验证您的 Citea 账号
   ```

6. **邮件内容**
   - 6 位验证码（例如：123456）
   - 有效期：10 分钟
   - 精美的 HTML 邮件模板

---

### 方法 2: 查看 Vercel 日志（排查问题）

如果没收到邮件，查看日志：

1. **访问 Vercel Dashboard**
   ```
   https://vercel.com/dashboard
   ```

2. **进入项目**
   - 选择你的项目
   - 点击 **Deployments**
   - 选择最新的部署

3. **查看 Function Logs**
   - 点击 **Functions** 标签
   - 或直接查看 **Logs**

4. **查找注册日志**
   
   **成功的日志**：
   ```
   验证邮件发送成功: {
     messageId: 'xxx',
     to: 'lihongyangnju@gmail.com',
     code: '12****'
   }
   ```
   → 邮件已发送，检查垃圾邮件文件夹

   **失败的日志**：
   ```
   邮件发送异常: {
     error: 'xxx',
     statusCode: 401
   }
   ```
   → 查看具体错误码

---

## 🔍 常见错误及解决方案

### 错误 1: `statusCode: 401`
**原因**: BREVO_API_KEY 无效或已过期

**解决方案**:
1. 访问 Brevo Dashboard: https://app.brevo.com/
2. 进入 **Settings** → **SMTP & API**
3. 检查 API Key 状态
4. 如果需要，重新生成 API Key
5. 更新 Vercel 环境变量
6. 重新部署

### 错误 2: `statusCode: 400`
**原因**: 发件邮箱未验证

**解决方案**:
- 使用默认发件邮箱：`noreply@brevo.com`
- 或在 Brevo 中验证自定义域名

### 错误 3: `statusCode: 402`
**原因**: Brevo 每日配额已用完（免费账户 300 封/天）

**解决方案**:
- 等待第二天重置
- 或升级到付费账户

### 错误 4: 没有错误日志，但没收到邮件
**原因**: 邮件被过滤到垃圾邮件

**解决方案**:
1. ⭐ 优先检查垃圾邮件文件夹
2. 检查促销内容标签（Gmail）
3. 搜索发件人：`noreply@brevo.com`
4. 搜索主题：`Citea`
5. 将发件人添加到联系人

---

## 📋 Vercel 环境变量检查清单

确认以下环境变量已配置：

```bash
✅ REDIS_URL = rediss://default:ATU-...@striking-longhorn-13630.upstash.io:6379
✅ BREVO_API_KEY = xkeysib-xxxxx... (刚刚重新配置的)
✅ BREVO_FROM_EMAIL = noreply@brevo.com (可选)
✅ JWT_SECRET = (随机字符串)
```

**重要**：
- 所有环境变量应用到三个环境：Production, Preview, Development
- 更新环境变量后，Vercel 会自动触发重新部署
- 等待部署完成（约 1-2 分钟）

---

## 🎯 快速测试流程

1. **确认 Vercel 最新部署已完成**
   - 查看 Deployments 页面
   - 状态应该是 ✅ Ready

2. **访问注册页面并注册**
   - 使用测试邮箱：`lihongyangnju@gmail.com`

3. **立即检查 Vercel 日志**
   - 查看是否有 "验证邮件发送成功" 或错误信息

4. **检查邮箱**
   - 优先查看垃圾邮件文件夹

5. **如果收到邮件**
   - ✅ 邮件服务配置成功！
   - 输入验证码完成验证

6. **如果没收到邮件**
   - 查看 Vercel 日志中的具体错误
   - 根据错误码查找上面的解决方案

---

## 🛠️ 本地测试工具

如果需要清理测试账号：

```bash
# 列出所有用户
node scripts/delete-user.js --list

# 删除测试账号
node scripts/delete-user.js lihongyangnju@gmail.com
```

---

## ⏱️ 邮件到达时间

- 通常：1-5 分钟
- 最长：10 分钟
- 如果超过 10 分钟未收到，检查日志确认是否发送成功

---

## 💡 提示

1. **垃圾邮件文件夹是最常见的问题**
   - Gmail 经常把新发件人的邮件放到垃圾邮件
   - 收到后，将发件人标记为"非垃圾邮件"

2. **Brevo 免费账户限制**
   - 每天 300 封邮件
   - 如果测试太多次可能会超限

3. **验证码有效期**
   - 10 分钟后过期
   - 可以使用"重新发送"功能

---

## ✅ 测试成功的标志

1. ✅ 注册后跳转到验证页面（无重复提示）
2. ✅ Vercel 日志显示 "验证邮件发送成功"
3. ✅ 收到邮件（可能在垃圾邮件文件夹）
4. ✅ 邮件包含 6 位验证码
5. ✅ 输入验证码后成功登录

---

现在可以开始测试了！建议先确认 Vercel 部署已完成，然后直接在网站注册测试。

