# 📧 免费邮件服务替代方案

## 当前情况
- ✅ Resend 免费额度已用完
- ⚠️ 只能绑定一个域名
- 💰 暂时无法升级付费

---

## 🆓 免费邮件服务方案

### 方案 1: Brevo (推荐！)

**免费额度**: 每天 300 封邮件（永久免费）

#### 优势
- ✅ 完全免费，无需信用卡
- ✅ 每天 300 封足够初期使用
- ✅ 支持自定义域名
- ✅ 提供 REST API 和 SMTP
- ✅ 有中文界面

#### 集成步骤

**1. 注册 Brevo**:
- 访问: https://www.brevo.com/
- 点击 "免费注册"
- 填写信息注册（无需信用卡）

**2. 获取 API Key**:
- 登录后进入 "SMTP & API"
- 点击 "Create a new API key"
- 复制 API Key

**3. 安装包**:
```bash
npm install @getbrevo/brevo
```

**4. 创建 Brevo 邮件服务**:
创建 `lib/email-brevo.ts`:
```typescript
import * as brevo from '@getbrevo/brevo'

const apiInstance = new brevo.TransactionalEmailsApi()
apiInstance.setApiKey(
  brevo.TransactionalEmailsApiApiKeys.apiKey,
  process.env.BREVO_API_KEY || ''
)

export async function sendVerificationEmail(email: string, code: string, name: string) {
  if (!process.env.BREVO_API_KEY) {
    console.warn('BREVO_API_KEY not configured')
    return { success: false, error: 'Email service not configured' }
  }

  try {
    const sendSmtpEmail = new brevo.SendSmtpEmail()
    sendSmtpEmail.to = [{ email, name }]
    sendSmtpEmail.sender = { 
      email: 'noreply@yourdomain.com', 
      name: 'Citea' 
    }
    sendSmtpEmail.subject = '验证您的 Citea 账号'
    sendSmtpEmail.htmlContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
            .header h1 { color: white; margin: 0; }
            .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 10px 10px; }
            .code-box { background: white; border: 2px solid #667eea; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; }
            .code { font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #667eea; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>🎓 Citea</h1>
            </div>
            <div class="content">
              <h2>您好, ${name}!</h2>
              <p>感谢您注册 Citea 账号。请使用以下验证码完成注册:</p>
              
              <div class="code-box">
                <div class="code">${code}</div>
              </div>
              
              <p>此验证码将在 <strong>10 分钟</strong>后过期。</p>
              <p>如果您没有注册 Citea 账号，请忽略此邮件。</p>
            </div>
          </div>
        </body>
      </html>
    `

    const result = await apiInstance.sendTransacEmail(sendSmtpEmail)
    return { success: true, data: result }
  } catch (error) {
    console.error('Brevo 邮件发送失败:', error)
    return { success: false, error }
  }
}

export async function sendWelcomeEmail(email: string, name: string) {
  if (!process.env.BREVO_API_KEY) {
    return { success: false, error: 'Email service not configured' }
  }

  try {
    const sendSmtpEmail = new brevo.SendSmtpEmail()
    sendSmtpEmail.to = [{ email, name }]
    sendSmtpEmail.sender = { 
      email: 'noreply@yourdomain.com', 
      name: 'Citea' 
    }
    sendSmtpEmail.subject = '欢迎加入 Citea!'
    sendSmtpEmail.htmlContent = `
      <!DOCTYPE html>
      <html>
        <head><meta charset="utf-8"></head>
        <body style="font-family: Arial, sans-serif; padding: 20px;">
          <h1 style="color: #667eea;">🎉 欢迎加入 Citea!</h1>
          <p>你好, ${name}!</p>
          <p>恭喜您成功注册 Citea 账号！</p>
          <h3>✨ 您现在可以使用:</h3>
          <ul>
            <li>📚 AI 文献查找</li>
            <li>✓ 引用验证</li>
            <li>💬 AI 助手</li>
          </ul>
          <p>祝您研究顺利！</p>
        </body>
      </html>
    `

    const result = await apiInstance.sendTransacEmail(sendSmtpEmail)
    return { success: true, data: result }
  } catch (error) {
    console.error('Brevo 欢迎邮件失败:', error)
    return { success: false, error }
  }
}
```

**5. 环境变量**:
```bash
BREVO_API_KEY=your_brevo_api_key_here
```

---

### 方案 2: Mailjet

**免费额度**: 每天 200 封，每月 6,000 封

#### 优势
- ✅ 完全免费
- ✅ 支持自定义域名
- ✅ REST API 和 SMTP
- ✅ 实时统计

#### 快速集成
```bash
npm install node-mailjet
```

环境变量:
```bash
MAILJET_API_KEY=your_api_key
MAILJET_SECRET_KEY=your_secret_key
```

---

### 方案 3: SendGrid (有限免费)

**免费额度**: 每天 100 封

#### 注意
- 需要信用卡验证
- 适合小规模测试

---

### 方案 4: Gmail SMTP（最简单！推荐测试用）

**免费额度**: 每天 500 封

#### 优势
- ✅ 完全免费
- ✅ 无需信用卡
- ✅ 5 分钟集成
- ✅ 稳定可靠

#### 集成步骤

**1. 生成 Gmail 应用专用密码**:
1. 登录 Gmail
2. 访问: https://myaccount.google.com/apppasswords
3. 选择 "邮件" 和 "其他设备"
4. 生成密码（16 位）

**2. 安装 Nodemailer**:
```bash
npm install nodemailer
```

**3. 创建 Gmail 邮件服务**:
创建 `lib/email-gmail.ts`:
```typescript
import nodemailer from 'nodemailer'

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.GMAIL_USER, // 你的 Gmail 地址
    pass: process.env.GMAIL_APP_PASSWORD, // 应用专用密码
  },
})

export async function sendVerificationEmail(email: string, code: string, name: string) {
  if (!process.env.GMAIL_USER || !process.env.GMAIL_APP_PASSWORD) {
    return { success: false, error: 'Gmail not configured' }
  }

  try {
    const info = await transporter.sendMail({
      from: `"Citea" <${process.env.GMAIL_USER}>`,
      to: email,
      subject: '验证您的 Citea 账号',
      html: `
        <!DOCTYPE html>
        <html>
          <head><meta charset="utf-8"></head>
          <body style="font-family: Arial, sans-serif; padding: 20px;">
            <h1 style="color: #667eea;">🎓 Citea</h1>
            <h2>您好, ${name}!</h2>
            <p>感谢您注册 Citea 账号。请使用以下验证码完成注册:</p>
            <div style="background: white; border: 2px solid #667eea; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;">
              <div style="font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #667eea;">${code}</div>
            </div>
            <p>此验证码将在 <strong>10 分钟</strong>后过期。</p>
          </body>
        </html>
      `,
    })

    return { success: true, data: info }
  } catch (error) {
    console.error('Gmail 发送失败:', error)
    return { success: false, error }
  }
}

export async function sendWelcomeEmail(email: string, name: string) {
  if (!process.env.GMAIL_USER || !process.env.GMAIL_APP_PASSWORD) {
    return { success: false, error: 'Gmail not configured' }
  }

  try {
    const info = await transporter.sendMail({
      from: `"Citea" <${process.env.GMAIL_USER}>`,
      to: email,
      subject: '欢迎加入 Citea!',
      html: `
        <h1 style="color: #667eea;">🎉 欢迎加入 Citea!</h1>
        <p>你好, ${name}!</p>
        <p>恭喜您成功注册 Citea 账号！</p>
        <h3>✨ 您现在可以使用:</h3>
        <ul>
          <li>📚 AI 文献查找</li>
          <li>✓ 引用验证</li>
          <li>💬 AI 助手</li>
        </ul>
      `,
    })

    return { success: true, data: info }
  } catch (error) {
    console.error('Gmail 欢迎邮件失败:', error)
    return { success: false, error }
  }
}
```

**4. 环境变量**:
```bash
GMAIL_USER=your-gmail@gmail.com
GMAIL_APP_PASSWORD=your-16-digit-app-password
```

---

## 📊 方案对比

| 方案 | 免费额度 | 配置难度 | 需要信用卡 | 自定义域名 | 推荐度 |
|------|---------|---------|-----------|-----------|--------|
| **Brevo** | 300/天 | ⭐⭐ | ❌ | ✅ | ⭐⭐⭐⭐⭐ |
| **Gmail SMTP** | 500/天 | ⭐ | ❌ | ❌ | ⭐⭐⭐⭐ |
| **Mailjet** | 200/天 | ⭐⭐ | ❌ | ✅ | ⭐⭐⭐⭐ |
| **SendGrid** | 100/天 | ⭐⭐⭐ | ✅ | ✅ | ⭐⭐⭐ |

---

## 🎯 推荐方案

### 立即可用（5 分钟）: Gmail SMTP
- 最简单，5 分钟集成
- 完全免费，每天 500 封
- 适合初期测试和小规模用户

### 长期方案（15 分钟）: Brevo
- 每天 300 封，永久免费
- 支持自定义域名
- 更专业的邮件服务

---

## 🚀 立即行动

### 方案 A: 使用 Gmail（最快）

1. **生成应用密码**:
   https://myaccount.google.com/apppasswords

2. **安装包**:
   ```bash
   npm install nodemailer
   ```

3. **我帮你创建文件**（告诉我你选这个方案）

### 方案 B: 使用 Brevo（推荐）

1. **注册 Brevo**:
   https://www.brevo.com/

2. **获取 API Key**

3. **我帮你集成**（告诉我你选这个方案）

---

## 💡 暂时绕过邮件验证（开发测试用）

如果你想先上线基本功能，可以暂时禁用邮件验证：

修改 `app/api/auth/signup/route.ts`:
```typescript
// 暂时跳过邮件验证，直接标记为已验证
const user = { 
  ...
  emailVerified: true,  // 直接设为 true
  // 不发送验证邮件
}

// 自动登录
const token = await signJwt(...)
await setAuthCookie(token)

return NextResponse.json({ user, needsVerification: false })
```

**⚠️ 警告**: 这样做会失去邮箱验证的安全性，仅适合开发测试！

---

## 选择你的方案

**告诉我你想用哪个方案，我立即帮你集成！**

1. Gmail SMTP（5 分钟，最简单）
2. Brevo（15 分钟，推荐长期使用）
3. 暂时禁用邮件验证（仅测试用）

我会立即帮你完成集成代码！🚀

