# 📧 Citea 邮箱验证功能说明

## ✅ 已完成的功能

### 1. 邮箱验证码系统
- ✅ 6 位数字验证码
- ✅ 10 分钟有效期
- ✅ 自动过期检查
- ✅ 重新发送功能

### 2. 邮件服务集成
- ✅ Resend 邮件服务
- ✅ 精美的 HTML 邮件模板
- ✅ 验证码邮件
- ✅ 欢迎邮件

### 3. 用户流程
- ✅ 注册 → 发送验证码 → 验证邮箱 → 自动登录
- ✅ 未验证用户无法登录
- ✅ 登录时提示验证邮箱
- ✅ 验证成功后发送欢迎邮件

### 4. 修复的问题
- ✅ 登录按钮无反应 → 已修复
- ✅ 添加调试日志
- ✅ 强制页面刷新

---

## 🚀 本地测试

### 1. 环境变量已配置

`.env.local` 已包含：
```bash
REDIS_URL=redis://...
JWT_SECRET=T4pJj3grK+iWLeNtaPtTP2jUhaxQHenJWiJnYohbsX4=
RESEND_API_KEY=re_9wZT2a8a_49TQF5EQTSGQxMR48wRphztm
NODE_ENV=development
```

### 2. 测试注册流程

1. **启动服务器**（已自动启动）：
   ```bash
   npm run dev
   ```
   访问：http://localhost:3000

2. **注册新用户**：
   - 访问：http://localhost:3000/auth/signup
   - 填写信息（使用真实邮箱！）
   - 点击注册

3. **检查邮箱**：
   - 查看收件箱
   - 如果没收到，查看垃圾邮件
   - 复制 6 位验证码

4. **验证邮箱**：
   - 注册后自动跳转到验证页面
   - 输入 6 位验证码
   - 点击"验证邮箱"

5. **验证成功**：
   - 自动登录
   - 跳转到 Dashboard
   - 收到欢迎邮件

### 3. 测试重新发送验证码

如果验证码过期或没收到：
1. 在验证页面点击"重新发送验证码"
2. 会生成新的 6 位验证码
3. 旧验证码失效

### 4. 测试登录限制

尝试用未验证的账号登录：
1. 注册但不验证邮箱
2. 尝试登录
3. 会提示"请先验证您的邮箱"
4. 点击确定跳转到验证页面

---

## 🌐 Vercel 部署

### 1. 添加环境变量

在 Vercel Dashboard → Settings → Environment Variables 添加：

```bash
REDIS_URL
值：redis://default:tI2IC8ylvKsvSFQ0k2wRraNv4MI5vlC8@redis-19318.c9.us-east-1-2.ec2.redns.redis-cloud.com:19318

JWT_SECRET
值：T4pJj3grK+iWLeNtaPtTP2jUhaxQHenJWiJnYohbsX4=

RESEND_API_KEY
值：re_9wZT2a8a_49TQF5EQTSGQxMR48wRphztm

NODE_ENV
值：production
```

### 2. 触发部署

代码已推送到 Git，Vercel 会自动部署。

或者手动触发：
```bash
git commit --allow-empty -m "trigger redeploy"
git push origin feat/redis-support
```

### 3. 部署后测试

1. 等待部署完成
2. 访问你的 Vercel 网址
3. 注册测试账号（使用真实邮箱）
4. 验证邮箱
5. 登录使用

---

## 📊 数据库结构

### 用户数据模型

```typescript
{
  id: string                    // UUID
  name: string                  // 用户名
  email: string                 // 邮箱
  passwordHash: string          // 加密密码
  plan: string                  // 订阅计划
  createdAt: string             // 创建时间
  lastLoginAt: string           // 最后登录
  emailVerified: boolean        // ✨ 邮箱是否已验证
  verificationCode: string      // ✨ 验证码
  verificationExpiry: string    // ✨ 验证码过期时间
}
```

---

## 🔍 API 端点

### 1. 注册 (已更新)
```typescript
POST /api/auth/signup
请求: { name, email, password }
响应: { 
  user, 
  needsVerification: true,
  message: '注册成功！请查看邮箱...'
}
效果: 创建用户 + 发送验证邮件
```

### 2. 验证邮箱 (新增)
```typescript
POST /api/auth/verify-email
请求: { email, code }
响应: { success, user, message }
效果: 验证邮箱 + 自动登录 + 发送欢迎邮件
```

### 3. 重新发送验证码 (新增)
```typescript
POST /api/auth/resend-code
请求: { email }
响应: { success, message }
效果: 生成新验证码 + 发送邮件
```

### 4. 登录 (已更新)
```typescript
POST /api/auth/signin
请求: { email, password }
响应: { user } 或 { error, needsVerification, email }
效果: 检查邮箱验证状态
```

---

## 📄 新增页面

### 验证邮箱页面
- 路径：`/auth/verify-email`
- 参数：`?email=xxx@example.com`
- 功能：
  - 输入 6 位验证码
  - 重新发送验证码
  - 实时验证
  - 自动跳转

---

## 🎨 邮件模板

### 1. 验证邮件
- 主题：验证您的 Citea 账号
- 内容：
  - 大号显示 6 位验证码
  - 10 分钟有效期提示
  - 精美的渐变设计
  - 品牌一致性

### 2. 欢迎邮件
- 主题：欢迎加入 Citea!
- 内容：
  - 欢迎信息
  - 功能介绍
  - 开始使用按钮
  - 支持信息

---

## ⚠️ 注意事项

### 1. Resend 测试域名
当前使用 Resend 的测试域名 `onboarding@resend.dev`，只能发送给：
- 你验证过的邮箱地址
- 需要在 Resend Dashboard 添加测试邮箱

**生产环境：**
- 需要配置自定义域名
- 在 Resend 添加并验证域名
- 修改 `lib/email.ts` 中的 `from` 地址

### 2. 邮件发送限制
- Resend 免费版：每月 3,000 封
- 每天 100 封
- 足够初期使用

### 3. 验证码有效期
- 当前：10 分钟
- 可在 `app/api/auth/signup/route.ts` 修改

### 4. 已验证用户
- 旧用户（之前注册的）没有 `emailVerified` 字段
- 会被视为未验证
- 需要重新验证或手动在数据库中设置

---

## 🐛 调试

### 查看日志
浏览器控制台会显示：
- 登录尝试
- 登录响应状态
- 错误信息

服务器日志会显示：
- 邮件发送结果
- 验证码生成
- 数据库操作

### 常见问题

**Q1: 收不到验证邮件**
- 检查 Resend API Key 是否正确
- 查看垃圾邮件文件夹
- 确认邮箱地址正确
- 在 Resend Dashboard 查看发送日志

**Q2: 验证码无效**
- 确认验证码未过期（10 分钟）
- 检查是否使用了旧验证码
- 尝试重新发送

**Q3: 验证后无法登录**
- 检查数据库中 `emailVerified` 字段
- 确认验证成功
- 查看浏览器 Cookie

---

## 📝 后续优化

### 短期
- [ ] 验证码改为可点击链接（更方便）
- [ ] 添加验证倒计时显示
- [ ] 邮件模板国际化

### 中期
- [ ] 配置自定义域名邮件
- [ ] 添加邮件发送队列
- [ ] 邮件发送失败重试

### 长期
- [ ] 短信验证备选方案
- [ ] 社交登录集成
- [ ] 邮件统计和分析

---

## ✅ 测试清单

- [x] 本地注册新用户
- [ ] 收到验证邮件
- [ ] 输入验证码成功
- [ ] 自动登录到 Dashboard
- [ ] 收到欢迎邮件
- [ ] 未验证用户无法登录
- [ ] 重新发送验证码
- [ ] 验证码过期处理
- [ ] Vercel 线上测试

---

**现在就去测试注册功能！** 🎉

**本地测试地址：** http://localhost:3000/auth/signup

**使用真实邮箱注册以接收验证码！**

