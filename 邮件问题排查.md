# 📧 邮件发送问题排查指南

## 🔍 问题现象

**显示"发送验证码成功"，但没有收到邮件**

## ✅ 快速检查清单

### 1️⃣ 检查邮件是否在垃圾邮件文件夹

**这是最常见的原因！**

- ✅ 检查 **垃圾邮件/Spam** 文件夹
- ✅ 检查 **促销邮件** 文件夹（Gmail）
- ✅ 检查 **其他** 文件夹（Outlook）
- ✅ 搜索发件人：`noreply@brevo.com` 或 `Citea`

---

### 2️⃣ 检查 Vercel 环境变量

访问：**Vercel Dashboard → Settings → Environment Variables**

确认以下变量已配置：

```bash
✅ BREVO_API_KEY = xkeysib-xxxxx...
✅ BREVO_FROM_EMAIL = noreply@brevo.com (或你的已验证邮箱)
```

**注意**：
- API Key 格式应为：`xkeysib-` 开头
- 如果只有 `BREVO_API_KEY` 没有 `BREVO_FROM_EMAIL`，会使用默认的 `noreply@brevo.com`

---

### 3️⃣ 检查 Brevo 配置状态

访问：https://app.brevo.com/

#### A. API Key 状态
1. 进入 **Settings** → **SMTP & API**
2. 检查 API Key 是否 **Active**
3. 检查 API Key 权限是否包含 **"Send emails"**

#### B. 发件邮箱验证状态
1. 进入 **Settings** → **Senders & IP**
2. 检查发件邮箱是否已验证 ✅
3. 如果使用自定义邮箱，确保域名已验证

#### C. 发送配额
1. 进入 **Statistics** 或 **Dashboard**
2. 检查是否超过每日 300 封的限制
3. 免费账户每日 300 封，如果超过会发送失败

---

### 4️⃣ 查看 Vercel 部署日志

访问：**Vercel Dashboard → Deployments → 最新部署 → Function Logs**

查找以下信息：

**成功日志**：
```
邮件发送成功: { messageId: 'xxx', to: 'user@example.com' }
```

**失败日志**：
```
邮件发送异常: { error: '...', statusCode: 401 }
```

**常见错误代码**：
- `401` - API Key 无效或已过期
- `400` - 邮件格式错误（通常是发件邮箱未验证）
- `402` - 配额已用完

---

### 5️⃣ 使用诊断工具

我已经为你创建了诊断 API：

#### A. 测试环境变量配置
```
GET https://your-domain.vercel.app/api/test-env
```

这会显示：
- ✅ Redis 配置
- ✅ 邮件服务配置
- ✅ 连接状态

#### B. 测试邮件发送
```bash
POST https://your-domain.vercel.app/api/test-email
Content-Type: application/json

{
  "email": "your-email@example.com"
}
```

这会：
- ✅ 发送测试邮件
- ✅ 显示详细错误信息（如果有）
- ✅ 显示配置状态

---

## 🔧 常见问题解决方案

### 问题 1: API Key 无效 (401)

**症状**：日志显示 `statusCode: 401`

**解决**：
1. 在 Brevo Dashboard 重新生成 API Key
2. 确保 API Key 权限包含 **"Send emails"**
3. 更新 Vercel 环境变量 `BREVO_API_KEY`
4. 重新部署应用

---

### 问题 2: 发件邮箱未验证 (400)

**症状**：日志显示 `statusCode: 400` 或邮件格式错误

**解决**：
- **选项 A**: 使用 Brevo 默认邮箱（无需验证）
  ```
  BREVO_FROM_EMAIL=noreply@brevo.com
  ```
  
- **选项 B**: 验证自定义邮箱
  1. 在 Brevo Dashboard 添加并验证域名
  2. 或使用 Brevo 提供的发件邮箱并验证

---

### 问题 3: 配额已用完 (402)

**症状**：日志显示 `statusCode: 402` 或 "配额已用完"

**解决**：
1. 等待第二天重置（免费账户每天 300 封）
2. 或升级到付费账户
3. 在 Brevo Dashboard 检查使用情况

---

### 问题 4: 邮件被标记为垃圾邮件

**症状**：邮件发送成功，但收不到

**解决**：
1. ✅ 检查垃圾邮件文件夹
2. ✅ 将发件人添加到联系人/白名单
3. ✅ 验证域名和 SPF/DKIM 记录（如果使用自定义域名）
4. ✅ 使用 Brevo 的默认域名 `noreply@brevo.com`（送达率更高）

---

### 问题 5: 邮件延迟

**症状**：邮件发送成功，但延迟收到

**原因**：
- 收件邮箱服务商的过滤规则
- 网络延迟
- Brevo 发送队列

**解决**：
- 通常会在 1-5 分钟内收到
- 如果超过 10 分钟未收到，检查垃圾邮件文件夹

---

## 🎯 快速诊断步骤

1. **检查垃圾邮件文件夹** ⭐⭐⭐ (最常见)
2. **查看 Vercel 日志** - 查看实际错误
3. **测试邮件 API** - `POST /api/test-email`
4. **检查 Brevo 配额** - 确认未超限
5. **验证 API Key** - 确认有效且权限正确

---

## 📝 测试邮件发送

使用命令行测试：

```bash
# 在项目根目录
node scripts/test-email.js your-email@example.com
```

这会：
- ✅ 使用 `.env.local` 中的配置
- ✅ 发送测试邮件
- ✅ 显示发送结果

---

## 💡 最佳实践

1. **使用验证过的发件邮箱**
   - 验证域名可以提高送达率
   - 使用 `noreply@brevo.com` 作为快速开始

2. **监控发送配额**
   - 免费账户每天 300 封
   - 定期检查使用情况

3. **查看日志**
   - 定期检查 Vercel Function Logs
   - 注意错误信息

4. **测试多个邮箱**
   - Gmail, Outlook, 163 等
   - 测试是否都能收到

---

## 🆘 还是无法解决？

请提供以下信息：

1. **Vercel Function Logs 中的错误信息**（最重要！）
2. **测试邮件 API 的返回结果**
3. **Brevo Dashboard 中的 API Key 状态**
4. **环境变量名称列表**（不包含值）
5. **是否检查了垃圾邮件文件夹**

---

## ✅ 验证邮件发送成功的标志

1. ✅ Vercel 日志显示：`邮件发送成功: { messageId: 'xxx' }`
2. ✅ 返回的 `messageId` 不为空
3. ✅ Brevo Dashboard 显示邮件已发送
4. ✅ 收到邮件（检查所有文件夹）

如果以上都满足但仍未收到，很可能是邮件被过滤到垃圾邮件文件夹。
