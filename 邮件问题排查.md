# 📧 邮件问题排查和解决方案

## ✅ 已解决的问题

### 1. 旧用户登录问题
**问题**: `lihongyangnju@gmail.com` 无法登录  
**原因**: 旧用户没有 `emailVerified` 字段  
**解决**: 已手动设置为已验证

**现在可以登录了！**

---

## ⚠️ 邮件发送问题

### 问题诊断

邮件服务配置正确（测试发送成功），但用户可能收不到邮件。

### 原因：Resend 测试域名限制

当前使用 `onboarding@resend.dev` 测试域名，有以下限制：

1. **只能发送给验证过的邮箱**
2. 需要在 Resend Dashboard 添加测试邮箱
3. 每天限制 100 封

---

## 🔧 解决方案

### 方案 1: 添加测试邮箱到 Resend（立即可用）

1. **访问 Resend Dashboard**:
   https://resend.com/emails

2. **添加测试邮箱**:
   - 点击右上角头像 → Settings
   - 找到 "Test Mode Emails"
   - 添加 `lihongyangnju@gmail.com`
   - 添加其他需要测试的邮箱

3. **测试**:
   ```bash
   node scripts/test-email.js lihongyangnju@gmail.com
   ```

### 方案 2: 配置自定义域名（推荐生产环境）

#### 步骤 1: 在 Resend 添加域名

1. 访问 https://resend.com/domains
2. 点击 "Add Domain"
3. 输入你的域名（例如：`citea.com`）
4. 点击 "Add"

#### 步骤 2: 配置 DNS 记录

Resend 会提供 DNS 记录，添加到你的域名 DNS 设置：

```
类型: TXT
名称: _resend
值: resend-verify=xxx...

类型: MX
名称: @
值: feedback-smtp.resend.com
优先级: 10

类型: TXT
名称: @
值: v=spf1 include:_spf.resend.com ~all
```

#### 步骤 3: 等待验证

DNS 生效需要几分钟到几小时。

#### 步骤 4: 修改代码

修改 `lib/email.ts`:

```typescript
from: 'Citea <noreply@citea.com>'  // 使用你的域名
```

#### 步骤 5: 重新部署

```bash
git add .
git commit -m "update email from address"
git push
```

---

## 🧪 测试邮件发送

### 使用测试脚本

```bash
# 测试发送到指定邮箱
node scripts/test-email.js your@email.com
```

### 检查邮件状态

1. 访问 Resend Dashboard: https://resend.com/emails
2. 查看最近发送的邮件
3. 检查发送状态和错误信息

---

## 📋 当前配置状态

### ✅ 已配置
- Resend API Key: `re_9wZT2a8a_...`
- 发件地址: `onboarding@resend.dev`
- 邮件模板: 验证码邮件 + 欢迎邮件

### ⚠️ 限制
- 测试域名只能发送给验证过的邮箱
- 每天 100 封限制
- 需要添加测试邮箱才能接收

### 🎯 推荐
- 生产环境配置自定义域名
- 可以发送给任何邮箱
- 更专业的发件人地址

---

## 🔍 调试步骤

### 1. 检查 Resend Dashboard

访问: https://resend.com/emails

查看:
- 邮件是否发送成功
- 发送状态（Delivered/Bounced/Failed）
- 错误信息

### 2. 检查垃圾邮件

Gmail 可能将邮件标记为垃圾邮件，检查:
- 垃圾邮件文件夹
- 促销邮件标签
- 社交邮件标签

### 3. 检查邮箱地址

确认:
- 邮箱地址拼写正确
- 邮箱可以接收邮件
- 没有被屏蔽

### 4. 查看服务器日志

本地开发查看控制台输出:
```
邮件发送成功: { id: '...' }
```

或者:
```
邮件发送失败: { error: '...' }
```

---

## 🚀 快速解决方案

### 立即可用（5分钟）

1. **添加测试邮箱到 Resend**:
   - 访问 https://resend.com/
   - 登录账号
   - Settings → Test Mode Emails
   - 添加 `lihongyangnju@gmail.com`

2. **重新注册测试**:
   - 访问 http://localhost:3000/auth/signup
   - 使用 `lihongyangnju@gmail.com` 注册
   - 应该能收到验证码

### 长期方案（1小时）

配置自定义域名（参考方案 2）

---

## 📞 需要帮助？

### Resend 支持
- 文档: https://resend.com/docs
- 支持: support@resend.com

### 常见问题

**Q: 为什么用测试域名收不到邮件？**  
A: 测试域名只能发送给在 Resend Dashboard 添加的邮箱

**Q: 如何查看邮件发送状态？**  
A: 访问 https://resend.com/emails 查看所有发送记录

**Q: 配置自定义域名需要多久？**  
A: DNS 生效通常需要 10 分钟到 1 小时

**Q: 免费版有什么限制？**  
A: 每月 3,000 封，每天 100 封，足够初期使用

---

## ✅ 下一步

1. **立即**: 添加测试邮箱到 Resend
2. **测试**: 重新注册并验证邮件
3. **生产**: 配置自定义域名

---

**现在去 Resend Dashboard 添加测试邮箱，然后重新测试注册！** 🎉

